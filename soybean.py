# Soybean crush spread
#
# Soybean crush spread is a value of soymeal and soy oil made 
# from a ton of soybeans less the costs of soybeans, expressed as 
# percentage of soybean price. 
#
# Dataset permalink:
# http://www.fao.org/giews/food-prices/tool/public/#/dataset/international?international=209_7_781_1_948,209_7_815_1_948,209_7_732_1_946,209_7_733_1_946&opt=monthly_nominal_tonne&tab=datatable&lang=en&utcstartdate=820454400000&utcenddate=1572566400000&btnZoomSelector=null
#
# Spread parameters:
# CBOT Soybeans vs. DCE Soybean Meal and Soybean Oil – Crush Spread
#

doc = """Date-Monthly,"INTERNATIONAL PRICES, Export, US, Soybean (US, c.i.f. Rotterdam), US Dollar/tonne" Commodity Code: CMM120101,"INTERNATIONAL PRICES, Export, US, Soybeans US No.1 Yellow (Gulf), US Dollar/tonne" Commodity Code: CMM530403,"INTERNATIONAL PRICES, Export, Unspecified, Soybean meal (44/45%, Hamburg, f.o.b. ex-mill), US Dollar/tonne" Commodity Code: CMM120800,"INTERNATIONAL PRICES, Export, Unspecified, Soybean oil (Dutch, f.o.b. ex-mill), US Dollar/tonne" Commodity Code: CMM150700
Nov-19,,352.27,,
Oct-19,385.00,351.94,319.00,762.00
Sep-19,365.00,330.96,315.00,760.00
Aug-19,382.00,333.15,314.00,775.00
Jul-19,374.00,345.39,322.00,742.00
Jun-19,371.00,348.32,337.00,726.00
May-19,345.00,320.79,320.00,733.00
Apr-19,364.00,333.24,318.00,733.00
Mar-19,373.00,343.27,320.00,734.00
Feb-19,380.00,346.05,330.00,770.00
Jan-19,382.00,342.08,343.00,746.00
Dec-18,382.00,338.13,344.00,726.00
Nov-18,373.00,329.30,340.00,734.00
Oct-18,368.00,320.16,347.00,760.00
Sep-18,358.00,306.09,347.00,757.00
Aug-18,380.00,331.31,363.00,766.00
Jul-18,378.00,335.43,382.00,775.00
Jun-18,398.00,360.54,391.00,786.00
May-18,431.00,397.60,443.00,793.00
Apr-18,442.00,403.23,447.00,827.00
Mar-18,432.00,396.53,427.00,834.00
Feb-18,418.00,386.45,400.00,842.00
Jan-18,405.00,372.59,361.00,864.00
Dec-17,399.00,365.55,348.00,866.00
Nov-17,401.00,369.22,333.00,881.00
Oct-17,399.00,368.15,329.00,867.00
Sep-17,397.00,368.72,329.00,882.00
Aug-17,390.00,366.09,318.00,855.00
Jul-17,408.00,378.87,326.00,835.00
Jun-17,380.00,352.23,313.00,827.00
May-17,388.00,364.07,329.00,827.00
Apr-17,389.00,356.73,331.00,791.00
Mar-17,404.00,377.67,346.00,812.00
Feb-17,427.00,394.53,357.00,835.00
Jan-17,425.00,393.24,355.00,872.00
Dec-16,420.00,390.88,345.00,907.00
Nov-16,412.00,383.12,343.00,880.00
Oct-16,403.00,371.84,340.00,858.00
Sep-16,405.00,385.48,344.00,829.00
Aug-16,413.00,400.04,375.00,814.00
Jul-16,432.00,420.18,400.00,788.00
Jun-16,457.00,441.70,430.00,798.00
May-16,422.00,401.68,406.00,791.00
Apr-16,393.00,366.90,339.00,796.00
Mar-16,375.00,342.48,301.00,761.00
Feb-16,369.00,342.54,303.00,758.00
Jan-16,367.00,347.34,316.00,727.00
Dec-15,372.00,345.94,317.00,761.00
Nov-15,368.00,342.97,328.00,726.00
Oct-15,376.00,357.95,351.00,742.00
Sep-15,368.00,356.43,362.00,727.00
Aug-15,381.00,370.39,373.00,730.00
Jul-15,405.00,399.49,389.00,751.00
Jun-15,397.00,389.92,372.00,793.00
May-15,385.00,380.68,371.00,781.00
Apr-15,396.00,383.87,380.00,753.00
Mar-15,402.00,386.63,392.00,748.00
Feb-15,407.00,395.42,412.00,773.00
Jan-15,421.00,397.84,431.00,799.00
Dec-14,446.00,411.95,449.00,820.00
Nov-14,447.00,420.89,485.00,830.00
Oct-14,430.00,400.20,463.00,836.00
Sep-14,433.00,407.22,463.00,851.00
Aug-14,457.00,485.05,485.00,857.00
Jul-14,480.00,504.61,477.00,888.00
Jun-14,514.00,554.68,531.00,936.00
May-14,522.00,570.41,552.00,966.00
Apr-14,516.00,575.58,563.00,999.00
Mar-14,501.00,555.30,582.00,"1,002.00"
Feb-14,594.00,531.44,571.00,985.00
Jan-14,566.00,517.89,539.00,943.00
Dec-13,568.00,526.22,548.00,989.00
Nov-13,556.00,511.58,541.00,996.00
Oct-13,544.00,509.67,555.00,987.00
Sep-13,556.00,536.24,552.00,"1,024.00"
Aug-13,516.00,522.76,564.00,999.00
Jul-13,509.00,577.71,567.00,995.00
Jun-13,524.00,591.36,548.00,"1,041.00"
May-13,497.00,579.54,527.00,"1,073.00"
Apr-13,495.00,564.01,521.00,"1,095.00"
Mar-13,511.00,561.18,503.00,"1,116.00"
Feb-13,596.00,564.58,513.00,"1,175.00"
Jan-13,592.00,562.44,512.00,"1,190.00"
Dec-12,607.00,574.98,553.00,"1,163.00"
Nov-12,589.00,567.01,539.00,"1,135.00"
Oct-12,617.00,591.77,555.00,"1,175.00"
Sep-12,670.00,644.62,604.00,"1,283.00"
Aug-12,684.00,647.78,619.00,"1,252.00"
Jul-12,662.00,638.65,584.00,"1,239.00"
Jun-12,567.00,546.39,503.00,"1,180.00"
May-12,573.00,544.64,492.00,"1,218.00"
Apr-12,575.00,549.06,471.00,"1,310.00"
Mar-12,543.00,518.33,426.00,"1,287.00"
Feb-12,512.00,491.97,385.00,"1,255.00"
Jan-12,498.00,469.71,371.00,"1,218.00"
Dec-11,474.00,446.64,347.00,"1,204.00"
Nov-11,486.00,453.52,357.00,"1,217.00"
Oct-11,503.00,468.36,378.00,"1,220.00"
Sep-11,543.00,504.32,396.00,"1,305.00"
Aug-11,558.00,527.34,402.00,"1,330.00"
Jul-11,559.00,530.57,405.00,"1,337.00"
Jun-11,558.00,527.95,395.00,"1,324.00"
May-11,556.00,524.80,403.00,"1,294.00"
Apr-11,556.00,520.81,406.00,"1,315.00"
Mar-11,553.00,520.10,423.00,"1,307.00"
Feb-11,575.00,527.42,447.00,"1,365.00"
Jan-11,582.00,527.47,454.00,"1,374.00"
Dec-10,547.00,513.71,436.00,"1,322.00"
Nov-10,526.00,483.01,428.00,"1,247.00"
Oct-10,493.00,447.78,409.00,"1,157.00"
Sep-10,470.00,414.28,396.00,"1,042.00"
Aug-10,457.00,406.60,383.00,"1,002.00"
Jul-10,429.00,394.46,361.00,907.00
Jun-10,408.00,370.79,342.00,859.00
May-10,407.00,368.99,353.00,865.00
Apr-10,411.00,370.58,376.00,902.00
Mar-10,408.00,370.41,389.00,915.00
Feb-10,406.00,367.61,393.00,914.00
Jan-10,436.00,383.80,407.00,923.00
Dec-09,450.00,398.96,425.00,935.00
Nov-09,440.00,393.04,425.00,931.00
Oct-09,427.00,385.44,430.00,897.00
Sep-09,421.00,384.22,425.00,846.00
Aug-09,470.00,434.21,438.00,886.00
Jul-09,463.00,415.11,430.00,837.00
Jun-09,503.00,466.89,446.00,896.00
May-09,465.00,444.13,437.00,892.00
Apr-09,414.00,389.84,388.00,801.00
Mar-09,379.00,358.17,344.00,727.00
Feb-09,390.00,369.87,381.00,748.00
Jan-09,413.00,391.15,369.00,789.00
Dec-08,360.00,347.20,300.00,738.00
Nov-08,378.00,356.59,323.00,824.00
Oct-08,394.00,354.09,338.00,926.00
Sep-08,509.00,455.65,407.00,"1,226.00"
Aug-08,556.00,493.46,436.00,"1,322.00"
Jul-08,634.00,574.18,508.00,"1,511.00"
Jun-08,622.00,556.98,512.00,"1,537.00"
May-08,575.00,494.45,469.00,"1,436.00"
Apr-08,558.00,489.25,470.00,"1,425.00"
Mar-08,575.00,512.66,443.00,"1,476.00"
Feb-08,572.00,511.81,469.00,"1,400.00"
Jan-08,541.00,471.14,434.00,"1,276.00"
Dec-07,515.00,426.31,425.00,"1,164.00"
Nov-07,489.00,405.94,397.00,"1,138.00"
Oct-07,450.00,366.37,384.00,"1,012.00"
Sep-07,426.00,354.25,342.00,959.00
Aug-07,385.00,316.05,297.00,908.00
Jul-07,376.00,309.36,289.00,885.00
Jun-07,361.00,304.21,270.00,833.00
May-07,334.00,284.06,258.00,788.00
Apr-07,320.00,274.42,253.00,761.00
Mar-07,322.00,280.17,258.00,718.00
Feb-07,325.00,288.96,262.00,714.00
Jan-07,306.00,268.61,247.00,697.00
Dec-06,297.00,260.36,235.00,699.00
Nov-06,300.00,266.00,232.00,675.00
Oct-06,273.00,238.70,224.00,615.00
Sep-06,258.00,222.32,215.00,602.00
Aug-06,262.00,223.14,208.00,629.00
Jul-06,272.00,235.45,202.00,630.00
Jun-06,267.00,229.41,201.00,601.00
May-06,266.00,229.75,198.00,588.00
Apr-06,258.00,223.24,193.00,540.00
Mar-06,257.00,228.27,192.00,539.00
Feb-06,257.00,232.99,204.00,535.00
Jan-06,257.00,234.40,207.00,532.00
Dec-05,264.00,241.44,210.00,537.00
Nov-05,256.00,230.20,200.00,560.00
Oct-05,257.00,226.06,202.00,579.00
Sep-05,263.00,225.79,212.00,545.00
Aug-05,274.00,246.82,220.00,549.00
Jul-05,298.00,267.01,224.00,561.00
Jun-05,306.00,266.66,221.00,559.00
May-05,283.00,249.61,217.00,538.00
Apr-05,283.00,243.12,226.00,547.00
Mar-05,290.00,245.59,230.00,546.00
Feb-05,261.00,216.21,204.00,497.00
Jan-05,262.00,220.16,207.00,521.00
Dec-04,265.00,224.09,198.00,553.00
Nov-04,260.00,217.30,193.00,567.00
Oct-04,249.00,210.24,197.00,558.00
Sep-04,260.00,218.83,205.00,585.00
Aug-04,265.00,234.49,200.00,610.00
Jul-04,279.00,309.33,208.00,597.00
Jun-04,295.00,341.56,239.00,581.00
May-04,316.00,367.11,281.00,632.00
Apr-04,358.00,371.43,310.00,671.00
Mar-04,413.00,373.51,306.00,691.00
Feb-04,368.00,327.93,279.00,689.00
Jan-04,350.00,315.74,278.00,658.00
Dec-03,332.00,297.05,264.00,638.00
Nov-03,327.00,294.04,270.00,625.00
Oct-03,310.00,283.54,253.00,624.00
Sep-03,264.00,244.95,209.00,558.00
Aug-03,237.00,220.34,192.00,512.00
Jul-03,230.00,228.21,190.00,523.00
Jun-03,239.00,204.28,200.00,541.00
May-03,250.00,241.86,199.00,538.00
Apr-03,251.00,217.45,188.00,524.00
Mar-03,241.00,224.18,187.00,508.00
Feb-03,243.00,226.04,192.00,521.00
Jan-03,244.00,225.42,203.00,535.00
Dec-02,241.00,223.01,179.00,585.00
Nov-02,243.00,224.59,186.00,577.00
Oct-02,229.00,212.30,182.00,517.00
Sep-02,236.00,220.57,183.00,494.00
Aug-02,227.00,218.71,173.00,503.00
Jul-02,274.00,220.07,177.00,470.00
Jun-02,200.00,196.71,172.00,438.00
May-02,197.00,188.93,169.00,397.00
Apr-02,195.00,180.83,166.00,370.00
Mar-02,191.00,178.14,164.00,353.00
Feb-02,187.00,170.56,169.00,358.00
Jan-02,188.00,173.10,182.00,389.00
Dec-01,189.00,173.93,173.00,403.00
Nov-01,189.00,173.36,182.00,388.00
Oct-01,187.00,171.30,182.00,376.00
Sep-01,202.00,185.39,184.00,382.00
Aug-01,212.00,195.63,183.00,422.00
Jul-01,208.00,199.00,186.00,409.00
Jun-01,188.00,182.59,182.00,315.00
May-01,184.00,174.92,172.00,295.00
Apr-01,186.00,168.01,161.00,321.00
Mar-01,195.00,177.77,169.00,329.00
Feb-01,200.00,181.81,183.00,302.00
Jan-01,210.00,191.36,215.00,306.00
Dec-00,217.00,199.15,223.00,321.00
Nov-00,206.00,186.68,203.00,316.00
Oct-00,203.00,181.99,194.00,313.00
Sep-00,209.00,191.13,193.00,312.00
Aug-00,198.00,181.90,176.00,329.00
Jul-00,197.00,184.96,175.00,340.00
Jun-00,211.00,197.70,188.00,328.00
May-00,229.00,203.38,191.00,340.00
Apr-00,229.00,201.77,180.00,368.00
Mar-00,221.00,198.16,180.00,362.00
Feb-00,214.00,197.29,187.00,357.00
Jan-00,208.00,190.74,180.00,371.00
Dec-99,199.00,,170.00,369.00
Nov-99,198.00,,169.00,382.00
Oct-99,203.00,,173.00,401.00
Sep-99,207.00,,167.00,414.00
Aug-99,199.00,,152.00,413.00
Jul-99,183.00,,138.00,392.00
Jun-99,194.00,,139.00,410.00
May-99,199.00,,140.00,428.00
Apr-99,207.00,,141.00,442.00
Mar-99,205.00,,142.00,444.00
Feb-99,205.00,,143.00,487.00
Jan-99,221.00,,152.00,546.00
Dec-98,230.00,,168.00,591.00
Nov-98,234.00,,163.00,614.00
Oct-98,223.00,,151.00,614.00
Sep-98,216.00,,145.00,615.00
Aug-98,219.00,,145.00,592.00
Jul-98,238.00,,157.00,612.00
Jun-98,242.00,,159.00,629.00
May-98,247.00,,162.00,671.00
Apr-98,259.00,,165.00,662.00
Mar-98,265.00,,184.00,652.00
Feb-98,273.00,,214.00,634.00
Jan-98,273.00,,231.00,625.00
Dec-97,284.00,,264.00,622.00
Nov-97,288.00,,276.00,676.00
Oct-97,278.00,,260.00,611.00
Sep-97,269.00,,266.00,555.00
Aug-97,265.00,,258.00,544.00
Jul-97,306.00,,248.00,535.00
Jun-97,327.00,,274.00,550.00
May-97,342.00,,300.00,541.00
Apr-97,338.00,,301.00,541.00
Mar-97,332.00,,300.00,541.00
Feb-97,308.00,,282.00,527.00
Jan-97,301.00,,280.00,534.00
Dec-96,289.00,,279.00,514.00
Nov-96,286.00,,274.00,517.00
Oct-96,290.00,,270.00,528.00
Sep-96,319.00,,286.00,569.00
Aug-96,317.00,,270.00,565.00
Jul-96,312.00,,265.00,549.00
Jun-96,308.00,,266.00,563.00
May-96,322.00,,271.00,591.00
Apr-96,316.00,,270.00,582.00
Mar-96,295.00,,246.00,538.00
Feb-96,299.00,,253.00,548.00
Jan-96,305.00,,260.00,554.00"""

#"INTERNATIONAL PRICES, Export, US, Soybean (US, c.i.f. Rotterdam), US Dollar/tonne" Commodity Code: CMM120101,
#"INTERNATIONAL PRICES, Export, US, Soybeans US No.1 Yellow (Gulf), US Dollar/tonne" Commodity Code: CMM530403,
#"INTERNATIONAL PRICES, Export, Unspecified, Soybean meal (44/45%, Hamburg, f.o.b. ex-mill), US Dollar/tonne" Commodity Code: CMM120800,
#"INTERNATIONAL PRICES, Export, Unspecified, Soybean oil (Dutch, f.o.b. ex-mill), US Dollar/tonne" Commodity Code: CMM150700
columns = "date beanr beang meal oil".split()

from datetime import date 
import io
import pandas as pd
from arrow import get
import numpy as np
import matplotlib.pyplot as plt

def date_reader(date_string):
    return get(date_string, 'MMM-YY').date()

def comma_reader(s: str):
    try:
        return float(s.replace(',', ''))
    except:
        return np.nan

assert date_reader('Jul-96') == date(1996, 7, 1)
assert comma_reader('1,000') == 1000


df = pd.read_csv(io.StringIO(doc), 
                 names=columns, 
                 index_col='date',
                 converters=dict(date=date_reader,
                                 oil=comma_reader), 
                 skiprows=1)

df = df.sort_index()
df['bean'] = (df.beanr + df.beang)/2
df['spread'] = 0.8 * df.meal + 0.183 * df.oil - df.bean
df['margin'] = (df.spread / df.bean)
df['margin_ma'] = df.margin.rolling(12).mean()

pf = df[['margin', 'margin_ma']].multiply(100).round(1)

t_ru = ("Разница цен между продуктами переработки сои\n"
     "и соевыми бобами ('краш-спред'),\n" 
     "% от цены сырья, скользящая средняя за 12 месяцев")
t_en = ("Soybean crush spread, % of soybean price,\nactual vs 12-month moving average")


def make_date(year):
    return get(str(year),'YYYY').date()    

def plot(pf, title):
    my_dpi = 80
    plt.figure(figsize=(506/my_dpi, 253/my_dpi), dpi=my_dpi)
    dates = [make_date(year) for year in (2000, 2020)]
    ax_ = pf.margin \
      .plot(
            xlim=dates, 
            yticks=[-5, 0, 5, 10, 15, 20, 25],
            xticks=[make_date(2000+i*5) for i in range(5)],
            color= 'turquoise',
            linewidth = 0.5,
            title=t_en)
    ax_ = pf.margin_ma \
       .plot(
            xlim=dates,
            color='teal',
            ax=ax_)
    ax_.set_xlabel("")  
    return ax_
    

ax = plot(pf, t_en)
plt.savefig('spread.png', bbox_inches = 'tight')

latest = pf.dropna().iloc[-1,:]    
print('Latest value (%s):' % latest.name.strftime('%b-%Y'), f'{latest.margin}%')
print(f'12-month moving average: {latest.margin_ma}%') 
